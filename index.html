<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Encuesta PSM</title>
  <style>
    :root{--b:#e5e7eb;--bg:#fafafa;--err:#b00020;--ok:#0a7a0a}
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);margin:0;padding:24px}
    .container{max-width:1200px;margin:0 auto;background:white;border:1px solid var(--b);border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.06);padding:20px}
    h1{margin:0 0 12px 0}
    label{font-weight:600;font-size:14px}
    input,select,textarea{width:100%;padding:10px;border:1px solid var(--b);border-radius:8px;background:white;box-sizing:border-box}
    textarea{resize:vertical}

    /* layout meta */
    .meta{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:10px}
    .meta-2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
    @media (min-width:900px){
      .meta{grid-template-columns:2fr 2fr}
      .meta-2{grid-template-columns:2fr 1fr}
    }

    .toolbar{display:flex;gap:8px;align-items:center;margin:8px 0 12px 0;flex-wrap:wrap}
    button{padding:10px 14px;border:1px solid var(--b);border-radius:8px;background:#111827;color:white;font-weight:600;cursor:pointer}
    button.secondary{background:white;color:#111827}
    .status{margin-left:8px}
    .small{font-size:12px;color:#374151}
    details{margin-top:4px}
    .pill{display:inline-block;background:#eef2ff;border:1px solid #c7d2fe;padding:2px 8px;border-radius:999px;font-size:12px;margin:4px 6px 0 0}
    .right{margin-left:auto}

    /* Instrucciones */
    .guide{border:1px solid var(--b);background:#f9fafb;border-radius:10px;padding:14px;margin:10px 0 14px 0;max-height:260px;overflow:auto;line-height:1.4}
    .guide h3{margin:6px 0 8px 0;} .guide ul{margin:6px 0 12px 18px;} .guide li{margin:3px 0;}

    /* progreso */
    .progress{height:8px;background:#e5e7eb;border-radius:6px;overflow:hidden}
    .bar{height:100%;width:0%;background:#0ea5e9;transition:width .2s}

    /* tabla */
    table{ table-layout:fixed; border-collapse:collapse; width:100% }
    th, td{ border:1px solid var(--b); padding:10px; vertical-align:top; word-wrap:break-word }
    thead th{position:sticky;top:0;background:#111827;color:white;z-index:1}
    input[type="number"], input[type="text"], textarea{display:block;width:100%;max-width:100%;box-sizing:border-box;margin:0;line-height:1.25}
    td:nth-child(4) input[type="number"]{ height:38px; }
    td:nth-child(5) input[type="text"]{ min-height:38px; }
    td:nth-child(6) textarea{ min-height:60px; }
    td{ overflow:hidden; }

    /* validación */
    .invalid{
      border-color: var(--err)!important;
      outline: 2px solid rgba(176,0,32,.15);
      background: #fff7f7;
    }
    .hint{ color: var(--err); font-size: 12px; margin-top: 4px; display:none; }
    .hint.show{ display:block; }
  </style>
</head>
<body>
<div class="container">
  <h1>Encuesta PSM</h1>

  <!-- Instrucciones -->
  <div class="guide">
    <h3>Instrucciones</h3>
    <p>En la utilización de la herramienta para la construcción de una línea base de seguridad de procesos, basada en RBPS (Risk Based Process Safety), ten en cuenta:</p>
    <ul>
      <li>Pilares RBPS: <b>COMPROMISO, ENTENDIMIENTO, GESTIÓN, APRENDER DE LA EXPERIENCIA</b>.</li>
      <li>Cada elemento se califica con factores críticos de éxito en tres niveles: <b>BAJO</b>, <b>MEDIO</b>, <b>ALTO</b>.</li>
      <li><b>Calificación</b> usa enteros 1–10:
        <div style="margin-left:14px">1–3: <b>BAJO</b> | 4–7: <b>MEDIO</b> | 8–10: <b>ALTO</b></div>
      </li>
      <li>En “Resultados” se consolida el avance por elemento y el total del sistema.</li>
    </ul>
    <p><b>NOTA:</b> Escala lineal (sin ponderación) en esta versión.</p>
    <p class="small">© ARL SURA, abril 2018. Derechos reservados.</p>
  </div>

  <!-- Meta mínimos -->
  <div class="meta">
    <div><label>Nombre</label><input id="nombre" required></div>
    <div><label>Apellido</label><input id="apellido" required></div>
  </div>
  <div class="meta-2">
    <div><label>Área / Equipo</label><input id="area" placeholder="Operaciones, Mantenimiento, HSE…" required></div>
    <div><label>Responder por</label>
      <select id="modo">
        <option>Usuario</option>
        <option>Área</option>
      </select>
    </div>
  </div>

  <!-- Progreso -->
  <div class="progress" title="Progreso de calificaciones"><div class="bar" id="bar"></div></div>
  <div class="small" id="pct" style="text-align:right;margin-top:4px;">0%</div>

  <div class="toolbar">
    <button id="filtrar">Cargar preguntas</button>
    <button id="enviar">Enviar Respuestas</button>
    <button id="descargar" class="secondary">Descargar CSV local</button>
    <div class="right small" id="autosave"></div>
    <span class="status" id="status"></span>
  </div>

  <div id="global-hint" class="hint"></div>

  <table id="tabla">
    <colgroup>
      <col style="width:14%">
      <col style="width:34%">
      <col style="width:18%">
      <col style="width:8%">
      <col style="width:12%">
      <col style="width:14%">
    </colgroup>
    <thead>
      <tr>
        <th>QuestionID</th>
        <th>Pregunta</th>
        <th>Guía de nivel</th>
        <th>Calif. (1–10)</th>
        <th>Registro</th>
        <th>Observaciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
/* ============== CONFIG ============== */
const JSON_URL = "preguntas.json?v=1";
const ENDPOINT = "https://script.google.com/macros/s/AKfycbzeyrl7uh88IeH7uS01LtemFRVgIAyc5kySvSlgZjNHHlqL5rB3t9stuqjWWU8Dogy8/exec";

/* ============== ESTADO ============== */
let DATA = null; // {Pilar:{Elemento:[{id,componente,pregunta,niveles},...]}}
let TOTAL = 0;
const slug = s => (s||'').toString().trim().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,'');

/* ============== CARGA JSON ============== */
fetch(JSON_URL).then(r=>r.json()).then(d=>{ DATA = d; });

/* ============== LOAD ALL (116) ============== */
document.getElementById('filtrar').addEventListener('click', ()=>{
  const nombre = val('nombre'), apellido = val('apellido'), area = val('area');
  if (!nombre || !apellido || !area) { setStatus('Completa Nombre, Apellido y Área antes de cargar.', true); return; }
  if (!DATA) { setStatus('Aún cargando preguntas, intenta de nuevo…', true); return; }

  let items = Object.values(DATA).flatMap(pilarObj => Object.values(pilarObj).flat());
  const num = qid => { const t = String(qid||'').split('-').pop(); const n = parseInt(t,10); return isNaN(n)? Infinity : n; };
  items.sort((a,b)=> num(a.id) - num(b.id));

  renderRows(items);
  restoreAnswers();
  computeProgress();
  persist(); // guarda el estado inicial de la tabla
  setStatus(`Cargadas ${items.length} preguntas.`);
});

/* ============== RENDER TABLA ============== */
function renderRows(items){
  const tb = document.querySelector('#tabla tbody');
  tb.innerHTML = '';
  TOTAL = items.length;
  items.forEach(x=>{
    const tr = document.createElement('tr');
    const niveles = x.niveles || {};
    const guia = Object.entries(niveles).map(([r,txt])=>`<div><b>${r}</b>: ${txt}</div>`).join('');
    tr.innerHTML = `
      <td>
        <div class="small">${x.id}</div>
        <div class="pill">${x.componente || ''}</div>
      </td>
      <td>${x.pregunta}</td>
      <td class="small"><details><summary>► Ver guía</summary>${guia||'Sin guía'}</details></td>
      <td>
        <input type="number" min="1" max="10" step="1" inputmode="numeric" pattern="[0-9]*"
          data-k="calificacion" data-id="${x.id}" aria-label="Calificación (1 a 10)">
      </td>
      <td><input type="text" placeholder="Código doc, URL, ruta…" data-k="registro" data-id="${x.id}"></td>
      <td><textarea rows="2" data-k="observaciones" data-id="${x.id}"></textarea></td>
    `;
    tb.appendChild(tr);
  });

  // autosave + validación + progreso
  document.querySelectorAll('[data-id]').forEach(n=>{
    n.addEventListener('input', ()=>{
      if (n.dataset.k === 'calificacion') validateScore(n, false);
      scheduleAutosave();
      if (n.dataset.k === 'calificacion') computeProgress();
    });
  });
}

/* ============== VALIDACIÓN CALIFICACIÓN 1–10 ENTERO ============== */
function isValidInt1to10(v){
  if (v === '' || v === null || v === undefined) return false;
  const n = Number(v);
  if (!Number.isInteger(n)) return false;
  return n >= 1 && n <= 10;
}
function validateScore(input, showMsg=true){
  const v = input.value.trim();
  const ok = isValidInt1to10(v);
  const msg = 'La calificación debe ser un número entero entre 1 y 10.';
  if (!ok && v !== '') {
    input.classList.add('invalid');
    if (showMsg) input.reportValidity?.();
    input.title = msg;
    input.setAttribute('aria-invalid','true');
  } else {
    input.classList.remove('invalid');
    input.title = '';
    input.removeAttribute('aria-invalid');
  }
  return ok || v === ''; // válido o vacío (vacío = no responde aún)
}
function validateAllScores(){
  const inputs = Array.from(document.querySelectorAll('input[data-k="calificacion"]'));
  let invalid = 0;
  let firstBad = null;
  inputs.forEach(i=>{
    const ok = validateScore(i, false);
    if (!ok && i.value !== '') { invalid++; if (!firstBad) firstBad = i; }
  });
  const hint = document.getElementById('global-hint');
  if (invalid > 0) {
    hint.textContent = `Hay ${invalid} calificaciones inválidas. Deben ser enteros de 1 a 10.`;
    hint.classList.add('show');
    if (firstBad) firstBad.scrollIntoView({behavior:'smooth',block:'center'});
  } else {
    hint.textContent = '';
    hint.classList.remove('show');
  }
  return invalid === 0;
}

/* ============== PROGRESO ============== */
function computeProgress(){
  const done = Array.from(document.querySelectorAll('input[data-k="calificacion"]'))
    .filter(i => isValidInt1to10(i.value)).length;
  const pct = TOTAL ? Math.round((done / TOTAL) * 100) : 0;
  document.getElementById('bar').style.width = pct + '%';
  document.getElementById('pct').textContent = pct + '%';
}

/* ============== RECOLECCIÓN ============== */
function val(id){ return document.getElementById(id).value.trim(); }
function makeSubmissionId(nombre, apellido, area){
  const ts = new Date().toISOString().replace(/[-:T.Z]/g,'').slice(0,14);
  return `${slug(apellido)}_${slug(nombre)}_${slug(area)}_${ts}`;
}
function collectRows(){
  const nombre = val('nombre'), apellido = val('apellido'), area = val('area');
  const modo = document.getElementById('modo').value;
  const fecha = new Date().toISOString().slice(0,10); // fija automática
  const pilar = 'Todos', elemento = 'Todos', componente = '';

  const inputs = Array.from(document.querySelectorAll('[data-id]'));
  const map = {};
  inputs.forEach(n=>{
    const id = n.dataset.id, k = n.dataset.k;
    map[id] = map[id] || { calificacion:null, registro:"", observaciones:"" };
    map[id][k] = n.value;
  });

  const rows = Object.entries(map)
    .filter(([,v])=> isValidInt1to10(v.calificacion)) // solo válidas 1–10 enteros
    .map(([id,v])=>({
      submissionId: makeSubmissionId(nombre, apellido, area),
      nombre, apellido, area, fecha, modo,
      pilar, elemento, componente,
      pregunta_id: id,
      calificacion: Number(v.calificacion),
      registro: v.registro||"",
      observaciones: v.observaciones||""
    }));
  return rows;
}

/* ============== ENVÍO ============== */
document.getElementById('enviar').addEventListener('click', async()=>{
  const nombre = val('nombre'), apellido = val('apellido'), area = val('area');
  if (!nombre || !apellido || !area) { setStatus('Completa Nombre, Apellido y Área.', true); return; }

  // Valida calificaciones antes de enviar
  if (!validateAllScores()) { setStatus('Corrige las calificaciones inválidas antes de enviar.', true); return; }

  const rows = collectRows();
  if (!rows.length) { setStatus('Debes calificar al menos una pregunta con un entero entre 1 y 10.', true); return; }
  if (!ENDPOINT || ENDPOINT.includes('PEGAR_AQUI_TU_URL_EXEC_DE_APPS_SCRIPT')) {
    setStatus('Configura ENDPOINT (Apps Script) o usa CSV.', true); return;
  }
  try{
    setStatus('Enviando…');
    await fetch(ENDPOINT, {
      method:'POST',
      mode:'no-cors',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({rows})
    });
    setStatus('✅ Formulario enviado. Revisa PSM_Responses y la carpeta de envíos.');
    clearAutosave();
  }catch(err){
    setStatus('❌ Error al enviar', true);
  }
});

/* ============== CSV LOCAL ============== */
document.getElementById('descargar').addEventListener('click', ()=>{
  if (!validateAllScores()) { setStatus('Corrige las calificaciones inválidas antes de descargar.', true); return; }
  const rows = collectRows();
  if(!rows.length){ setStatus('No hay filas válidas (1–10).', true); return; }
  const headers = Object.keys(rows[0]);
  const csv = [headers.join(',')].concat(rows.map(r=>headers.map(h=>csvEsc(r[h])).join(','))).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'respuestas_psm.csv'; a.click();
});
function csvEsc(v){ let s = String(v==null?'':v); if(s.includes('"')||s.includes(',')||s.includes('\n')) s = '"' + s.replace(/"/g,'""') + '"'; return s; }
function setStatus(t, err=false){ const el = document.getElementById('status'); el.textContent = t; el.style.color = err? 'var(--err)':'var(--ok)'; }

/* ============== AUTOSAVE EXTENDIDO ============== */
function hhmm(d=new Date()){
  try { return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); } catch(_) { return ''; }
}
// Clave del borrador basada en meta; si no hay meta aún, usa 'anon'
function lsKey(){
  const nombre   = document.getElementById('nombre').value.trim();
  const apellido = document.getElementById('apellido').value.trim();
  const area     = document.getElementById('area').value.trim();
  const base = (nombre || apellido || area) ? `${slug(apellido)}:${slug(nombre)}:${slug(area)}` : 'anon';
  return `psm:${base}`;
}
let saveTimer=null;
function scheduleAutosave(){
  const el = document.getElementById('autosave');
  if (el) el.textContent = 'Guardando borrador…';
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(persist, 500);
}
['nombre','apellido','area','modo'].forEach(id=>{
  const el = document.getElementById(id);
  el && el.addEventListener('input', scheduleAutosave);
});
function persist(){
  const key = lsKey();
  const payload = {
    meta: {
      nombre: val('nombre'),
      apellido: val('apellido'),
      area: val('area'),
      modo: document.getElementById('modo').value
    },
    answers: {}
  };
  document.querySelectorAll('[data-id]').forEach(n=>{
    const id = n.dataset.id, k = n.dataset.k;
    payload.answers[id] = payload.answers[id] || {};
    payload.answers[id][k] = n.value;
  });
  try {
    localStorage.setItem(key, JSON.stringify(payload));
    localStorage.setItem('psm:last', key); // puntero al último borrador
    const as = document.getElementById('autosave');
    if (as) as.textContent = 'Borrador guardado ✓ ' + hhmm();
  } catch(_){}
}
function restoreAnswers(){
  let key = lsKey();
  let raw = localStorage.getItem(key);
  if (!raw) {
    const lastKey = localStorage.getItem('psm:last');
    if (lastKey) { raw = localStorage.getItem(lastKey); if (raw) key = lastKey; }
  }
  if(!raw) return;
  try{
    const data = JSON.parse(raw);
    for(const [k,v] of Object.entries(data.meta||{})){
      const el = document.getElementById(k);
      if(el && !el.value) el.value = v;
    }
    const ans = data.answers||{};
    for(const [qid,vals] of Object.entries(ans)){
      for(const [k,val] of Object.entries(vals)){
        const el = document.querySelector(`[data-id="${qid}"][data-k="${k}"]`);
        if(el) el.value = val;
      }
    }
    const as = document.getElementById('autosave');
    if (as) as.textContent = 'Borrador restaurado';
  }catch(_){}
}
function clearAutosave(){ localStorage.removeItem(lsKey()); document.getElementById('autosave').textContent = ''; }

// Guarda cuando la pestaña se oculta / pierde foco / antes de salir
document.addEventListener('visibilitychange', ()=>{ if (document.visibilityState === 'hidden') { try { persist(); } catch(_){} }});
window.addEventListener('blur', ()=>{ try { persist(); } catch(_){} });
window.addEventListener('beforeunload', ()=>{ try { persist(); } catch(_){} });

// Heartbeat: guarda cada 30 s
setInterval(()=>{ try { persist(); } catch(_){} }, 30000);

// Restaura automáticamente al cargar
window.addEventListener('load', ()=>{ try { restoreAnswers(); } catch(_){} });

</script>
</body>
</html>
